<!DOCTYPE html>
<html lang="pt-BR">
{{> head }}

<body>
    <!-- Navbar -->
    <header class="custom-header">
        {{> navbar_home }}
    </header>
    <br />

    <!-- Seção Principal -->
    <section class="py-5 bg-light">
        <div class="container">
            <h2 class="text-center mb-4">Bem-vindo, {{nomeFornecedor}}!</h2>
            <p class="text-center mb-5">
                Gerencie suas economias e acompanhe seu desempenho na plataforma.
            </p>

            {{#if flag}}
            <!-- Dashboard -->
            <div class="row g-4 justify-content-center text-center">
                <div class="col-md-6">
                    <div class="card shadow-sm p-4 card-dashboard">
                        <h5 class="text-warning">Total de KWh consumido no mês:</h5>
                        <p class="display-5 fw-bold">{{formatarBR consumo_medio}} kWh</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm p-4 card-dashboard">
                        <h5 class="text-warning">Valor Total da Fatura</h5>
                        <p class="display-5 fw-bold">R$ {{formatarBR valor_medio_contas}}</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm p-4 card-dashboard">
                        <h5 class="text-warning">Valor com Desconto SOLARO</h5>
                        <p class="display-5 fw-bold">R$ {{formatarBR valor_com_desconto}}</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm p-4 card-dashboard">
                        <h5 class="text-success">Valor Economizado</h5>
                        <p class="display-5 fw-bold">R$ {{formatarBR economia_estimada}}</p>
                    </div>
                </div>
            </div>

            <!-- Espaço -->
            <div style="height: 30px;"></div>

            {{else}}
            <!-- Simulador -->
            <section class="my-5 border-simulador">
                <h4 class="mb-4 text-center">Simule sua Economia</h4>
                <form id="simuladorForm" method="POST" action="/Simular-Contrato">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label d-flex align-items-center gap-2">
                                Consumo de kWh nos 3 últimos meses:
                                <div id="tooltipIcon" style="cursor: pointer;" data-bs-toggle="tooltip"
                                    data-bs-html="true" data-bs-placement="right">
                                    <i class="bi bi-info-circle-fill text-dark"></i>
                                </div>
                            </label>

                            <input type="number" step="0.01" class="form-control mb-2" id="kwh1"
                                placeholder="Mês 1 (kWh)" required>
                            <input type="number" step="0.01" class="form-control mb-2" id="kwh2"
                                placeholder="Mês 2 (kWh)" required>
                            <input type="number" step="0.01" class="form-control" id="kwh3" placeholder="Mês 3 (kWh)"
                                required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label d-flex align-items-center gap-2">
                                Valor das 3 últimas contas (R$):
                                <div id="tooltipIcon2" style="cursor: pointer;" data-bs-toggle="tooltip"
                                    data-bs-html="true" data-bs-placement="right">
                                    <i class="bi bi-info-circle-fill text-dark"></i>
                                </div>
                            </label>
                            <input type="number" step="0.01" class="form-control mb-2" id="conta1"
                                placeholder="Valor Conta 1 (R$)" required>
                            <input type="number" step="0.01" class="form-control mb-2" id="conta2"
                                placeholder="Valor Conta 2 (R$)" required>
                            <input type="number" step="0.01" class="form-control" id="conta3"
                                placeholder="Valor Conta 3 (R$)" required>
                        </div>

                        <div class="col-md-12">
                            <label for="resultado_calculado" class="form-label">Valor Mensal com Taxa</label>
                            <input type="text" class="form-control bg-light" id="resultado_calculado"
                                name="resultado_calculado" value="{{resultado_calculado}}" readonly>
                        </div>
                    </div>

                    <div class="d-flex justify-content-center mt-4">
                        <button type="submit" class="btn btn-primary px-4 py-2">
                            <i class="bi bi-calculator-fill me-2"></i>Simular Oferta
                        </button>
                    </div>
                </form>
            </section>

            <!-- Espaço -->
            <div style="height: 100px;"></div>

            <!-- Botão abre Modal -->
            <section class="container my-5">
                <div class="card border-start border-4 shadow-sm p-4 oferta-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h4 class="oferta-titulo mb-1">Cadastrar Nova Oferta</h4>
                            <small class="oferta-subtitulo">Solicite uma nova oferta de energia solar personalizada para
                                você.</small>
                        </div>
                        <button
                            class="btn btn-outline-primary btn-lg px-5 py-3 shadow-sm fw-bold animate__animated animate__pulse animate__infinite"
                            data-bs-toggle="modal" data-bs-target="#modalOferta">
                            <i class="bi bi-plus-circle me-2"></i> Cadastrar Nova Oferta
                        </button>
                    </div>
                </div>
            </section>
            {{/if}}
        </div>
    </section>

    <!-- Modal de Cadastro de Oferta -->
    <div class="modal fade" id="modalOferta" tabindex="-1" aria-labelledby="modalOfertaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="POST" action="/cadastro_contrato_cliente">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalOfertaLabel">Cadastrar Nova Oferta</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <div class="mb-3">
                            <label class="form-label">Consumo de kWh nos 3 últimos meses:</label>
                            <input type="number" step="0.01" class="form-control mb-2" name="kwh1"
                                placeholder="Mês 1 (kWh)" required>
                            <input type="number" step="0.01" class="form-control mb-2" name="kwh2"
                                placeholder="Mês 2 (kWh)" required>
                            <input type="number" step="0.01" class="form-control" name="kwh3" placeholder="Mês 3 (kWh)"
                                required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Valor das 3 últimas contas (R$):</label>
                            <input type="number" step="0.01" class="form-control mb-2" name="conta1"
                                placeholder="Valor Conta 1 (R$)" required>
                            <input type="number" step="0.01" class="form-control mb-2" name="conta2"
                                placeholder="Valor Conta 2 (R$)" required>
                            <input type="number" step="0.01" class="form-control" name="conta3"
                                placeholder="Valor Conta 3 (R$)" required>
                        </div>

                        <div class="border rounded p-3 bg-light mb-3">
                            <h6 class="text-center fw-bold">Contrato de Consumo com a SOLARO</h6>
                            <ul class="small">
                                <li>Ao contratar pela plataforma SOLARO, você consome energia limpa fornecida por
                                    geradores parceiros, com total transparência e segurança.</li>
                                <li>O valor pago inclui o custo da energia contratada e uma taxa por estado que garante
                                    a operação e manutenção da plataforma.</li>
                                <li>O contrato tem início a partir da assinatura, sendo renovado mensalmente e podendo
                                    ser encerrado a qualquer momento.</li>
                                <li>O pagamento é realizado mensalmente, considerando o consumo efetivo registrado
                                    durante o período.</li>
                                <li>Os fornecedores parceiros garantem o fornecimento da energia contratada, conforme as
                                    condições acordadas na plataforma SOLARO.</li>
                            </ul>
                        </div>

                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="aceiteContrato" name="aceite_contrato"
                                required>
                            <label class="form-check-label" for="aceiteContrato">
                                Eu li e aceito os termos do contrato com a plataforma SOLARO.
                            </label>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Cadastrar Oferta e Assinar Contrato</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {{#if flag}}
    <!-- ABAS -->
    <div class="d-flex justify-content-center">
        <ul class="nav nav-tabs custom-tabs w-75 mb-4" id="myTab" role="tablist" style="max-width: 900px;">
            <li class="nav-item me-2" role="presentation">
                <button class="nav-link active" id="lancamento-tab" data-bs-toggle="tab" data-bs-target="#lancamento"
                    type="button" role="tab">
                    <i class="bi bi-upload me-1"></i> Lançamento
                </button>
            </li>
            <li class="nav-item me-2" role="presentation">
                <button class="nav-link" id="historico-tab" data-bs-toggle="tab" data-bs-target="#historico"
                    type="button" role="tab">
                    <i class="bi bi-clock-history me-1"></i> Histórico
                </button>
            </li>
            <button class="nav-link" id="faturas-tab" data-bs-toggle="tab" data-bs-target="#faturas" type="button"
                role="tab">
                <i class="bi bi-receipt me-1"></i> Faturas
            </button>
        </ul>
    </div>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="lancamento" role="tabpanel">
            <!-- Lançamento de KWh Mensal -->
            <section class="container my-5">
                <div class="card border-start border-4 shadow-sm p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h4 class="mb-1">Lançamento de kWh</h4>
                            <small class="text-muted">Informe sua geração de energia do mês</small>
                        </div>
                    </div>

                    <form method="POST" action="/salvar_kwh">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Mês Referente</label>
                                <select class="form-select" name="mes_referencia" required>
                                    <option value="">Selecione</option>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Março</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Total kWh Gerado</label>
                                <input type="number" step="0.01" class="form-control" name="kwh_gerado"
                                    placeholder="Ex.: 560.50" required>
                            </div>

                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-save me-2"></i> Salvar Lançamento
                            </button>
                        </div>
                    </form>
                </div>
            </section>

        </div>
        <div class="tab-pane fade" id="historico" role="tabpanel">
            <!-- Histórico de Lançamento -->
            <section class="container my-4">
                <div class="card shadow-sm p-4">
                    <h5 class="mb-3">Histórico de Lançamentos</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Mês</th>
                                    <th>kWh Gerado</th>
                                    <th>Valor Estimado</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each faturas}}
                                <tr>
                                    <td>{{mes}}</td>
                                    <td>{{formatarBR kwh}}</td>
                                    <td>{{valor}}</td>
                                    <td><span class="badge bg-{{statusClass}}">{{status}}</span></td>
                                </tr>
                                {{/each}}
                            </tbody>

                        </table>
                    </div>
                </div>
            </section>
        </div>

        <div class="tab-pane fade" id="faturas" role="tabpanel">
            <!-- Seção Minhas Faturas -->
            <section class="container my-5">
                <div class="card border-start border-4 shadow-sm p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h4 class="mb-1">Minhas Faturas</h4>
                            <small class="text-muted">Pagamento dos contratos ativos</small>
                        </div>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalPagamento">
                            <i class="bi bi-credit-card-2-front me-2"></i> Efetuar Pagamento
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Mês Referente</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                    <th>Opção</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each faturas}}
                                <tr>
                                    <td>{{mes}}</td>
                                    <td>{{valor}}</td>
                                    <td><span class="badge bg-{{statusClass}}">{{status}}</span></td>
                                    <td>
                                        {{#if mostrarBotaoPagar}}
                                        <button class="btn btn-outline-success btn-sm btn-pagar"
                                            data-id="{{id_pagamento_cliente}}" data-valor="{{valor}}"
                                            data-bs-toggle="modal" data-bs-target="#modalPagamento">
                                            Pagar
                                        </button>

                                        {{else}}
                                        {{forma_pagamento}}
                                        {{/if}}
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Modal de Pagamento -->
            <div class="modal fade" id="modalPagamento" tabindex="-1" aria-labelledby="modalPagamentoLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form onsubmit="event.preventDefault(); gerarRecibo(); this.submit();"
                            action="/confirmar_pagamento" method="POST">
                            <input type="hidden" name="id_fatura" id="inputIdFatura" />
                            <input type="hidden" name="valor" id="inputValorFatura" />

                            <div class="modal-header">
                                <h5 class="modal-title" id="modalPagamentoLabel">
                                    <i class="bi bi-credit-card-2-front me-2"></i> Efetuar Pagamento
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Fechar"></button>
                            </div>

                            <div class="modal-body">
                                <p>Valor da fatura: <strong id="valorFatura"> </strong></p>

                                <div class="mb-3">
                                    <label for="metodoPagamento" class="form-label">Método de Pagamento</label>
                                    <select id="metodoPagamento" class="form-select" name="metodo" required>
                                        <option value="" selected disabled>Selecione</option>
                                        <option value="pix">PIX</option>
                                        <option value="cartao">Cartão de Crédito</option>
                                        <option value="boleto">Boleto Bancário</option>
                                    </select>
                                </div>

                                <div id="infoPix" class="d-none">
                                    <p class="small mb-1">Chave PIX: <strong>financeiro@solaro.com.br</strong></p>
                                    <p class="small">Após o pagamento, envie o comprovante para <a
                                            href="mailto:suporte@solaro.com.br">suporte@solaro.com.br</a></p>
                                </div>

                                <div id="infoCartao" class="d-none">
                                    <label for="numCartao" class="form-label">Número do Cartão</label>
                                    <input id="numCartao" type="text" class="form-control mb-2"
                                        placeholder="XXXX XXXX XXXX XXXX" maxlength="19" />

                                    <div class="row">
                                        <div class="col">
                                            <label for="validadeCartao" class="form-label">Validade</label>
                                            <input id="validadeCartao" type="text" class="form-control"
                                                placeholder="MM/AA" maxlength="5" />
                                        </div>
                                        <div class="col">
                                            <label for="cvvCartao" class="form-label">CVV</label>
                                            <input id="cvvCartao" type="text" class="form-control" placeholder="123"
                                                maxlength="3" />
                                        </div>
                                    </div>
                                </div>

                                <div id="infoBoleto" class="d-none">
                                    <p class="small mb-0">Um boleto será gerado após a confirmação do pagamento.</p>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button type="submit" class="btn btn-success">Confirmar Pagamento</button>
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                            </div>
                        </form>

                    </div>
                </div>
            </div>

            <script>
                let dadosFatura = { mes: "", valor: "R$ 0,00" };

                function prepararPagamento(button) {
                    const mes = button.getAttribute('data-mes');
                    const valor = button.getAttribute('data-valor') || "0,00";
                    dadosFatura = { mes, valor };

                    // Atualiza o valor exibido no modal
                    document.getElementById('valorFatura').innerText = valor;
                }

                // Listener para exibir os campos de acordo com o método de pagamento
                document.getElementById('metodoPagamento').addEventListener('change', function () {
                    const pix = document.getElementById('infoPix');
                    const cartao = document.getElementById('infoCartao');
                    const boleto = document.getElementById('infoBoleto');

                    pix.classList.add('d-none');
                    cartao.classList.add('d-none');
                    boleto.classList.add('d-none');

                    if (this.value === 'pix') {
                        pix.classList.remove('d-none');
                    } else if (this.value === 'cartao') {
                        cartao.classList.remove('d-none');
                    } else if (this.value === 'boleto') {
                        boleto.classList.remove('d-none');
                    }
                });

                async function gerarRecibo() {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const data = new Date().toLocaleDateString("pt-BR");
                    const metodo = document.querySelector('[name="metodo"]').value || "Não informado";

                    // Configurações básicas
                    doc.setFont("helvetica");

                    // Título centralizado e negrito
                    doc.setFontSize(18);
                    doc.setFont(undefined, "bold");
                    doc.text("Recibo de Pagamento", doc.internal.pageSize.getWidth() / 2, 20, { align: "center" });

                    // Linha horizontal abaixo do título
                    doc.setDrawColor(0);
                    doc.setLineWidth(0.5);
                    doc.line(20, 25, doc.internal.pageSize.getWidth() - 20, 25);

                    // Corpo do recibo
                    doc.setFontSize(12);
                    doc.setFont(undefined, "normal");
                    const startY = 40;
                    const lineHeight = 10;

                    // Função para facilitar texto com label negrito
                    function addLabelValue(label, value, y) {
                        doc.setFont(undefined, "bold");
                        doc.text(`${label}:`, 20, y);
                        doc.setFont(undefined, "normal");
                        doc.text(value, 60, y);
                    }

                    addLabelValue("Mês Referente", dadosFatura.mes, startY);
                    addLabelValue("Valor Pago", dadosFatura.valor, startY + lineHeight);
                    addLabelValue("Método", metodo.toUpperCase(), startY + lineHeight * 2);
                    addLabelValue("Data do Pagamento ", data, startY + lineHeight * 3);

                    // Mensagem final
                    doc.setFont(undefined, "italic");
                    doc.setFontSize(11);
                    doc.text(
                        "Obrigado por utilizar o Solaro Marketplace!",
                        doc.internal.pageSize.getWidth() / 2,
                        startY + lineHeight * 6,
                        { align: "center" }
                    );

                    // Salvar o arquivo
                    doc.save(`recibo_solaro_${dadosFatura.mes.replace("/", "-")}.pdf`);


                    // Alerta 
                    Swal.fire({
                        icon: 'success',
                        title: 'Pagamento confirmado!',
                        text: 'Recibo gerado com sucesso.',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        // Fecha o modal após fechar o alerta
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalPagamento'));
                        if (modal) modal.hide();
                    });
                }
            </script>
        </div>
    </div>

    <!-- Seção de Contrato Ativo -->
    <section class="container my-5">
        <div class="card border-start border-4 shadow-sm p-4 oferta-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4 class="oferta-titulo mb-1">Contrato Ativo</h4>
                    <small class="oferta-subtitulo">Parceria com a plataforma SOLARO</small>
                </div>
                <button class="btn oferta-btn-outline-primary" data-bs-toggle="modal"
                    data-bs-target="#modalVisualizarContrato">
                    <i class="bi bi-file-earmark-text me-2"></i>Ver Detalhes
                </button>
            </div>

            <div class="row text-center text-md-start">
                <div class="col-md-4 mb-3 mb-md-0">
                    <p class="mb-1"><strong><i class="bi bi-calendar-check me-2"></i>Assinatura:</strong></p>
                    <p>{{data_assinatura}}</p>
                </div>
                <div class="col-md-4 mb-3 mb-md-0">
                    <p class="mb-1"><strong><i class="bi bi-calendar-x me-2"></i>Status:</strong></p>
                    <p>
                        {{#if (eq this.status "A")}}
                        <span class="badge bg-success">Ativo</span>
                        {{else}}
                        <span class="badge bg-secondary">Inativo</span>
                        {{/if}}
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal de Visualização -->
    <div class="modal fade" id="modalVisualizarContrato" tabindex="-1" aria-labelledby="visualizarContratoLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header oferta-bg-primary text-white">
                    <h5 class="modal-title" id="visualizarContratoLabel"><i
                            class="bi bi-file-earmark-text me-2"></i>Contrato de
                        Parceria com a SOLARO</h5>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <dl class="row">
                        <dt class="col-sm-4">Consumidor</dt>
                        <dd class="col-sm-8">{{nomeFornecedor}}</dd>

                        <dt class="col-sm-4">Estado do consumidor</dt>
                        <dd class="col-sm-8">{{estado_cliente}}</dd>

                        <dt class="col-sm-4">Média de consumo de kWh</dt>
                        <dd class="col-sm-8">{{formatarBR consumo_medio}} kWh</dd>

                        <dt class="col-sm-4">Média de valor de contas</dt>
                        <dd class="col-sm-8">R$ {{formatarBR valor_com_desconto}}</dd>

                        <dt class="col-sm-4">Data de Início</dt>
                        <dd class="col-sm-8">{{data_assinatura}}</dd>
                    </dl>
                    <hr>
                    <p class="small">
                        Este contrato estabelece os termos de parceria entre o consumidor {{nomeFornecedor}} e a
                        plataforma SOLARO
                        Marketplace.

                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger me-auto" id="btn-rescindir">
                        Rescindir Contrato
                    </button>

                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    {{!-- <!-- Modal Rescindir Contrato -->
    <div class="modal fade" id="modalAvisoMulta" tabindex="-1" aria-labelledby="modalAvisoMultaLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="modalAvisoMultaLabel">Aviso de Multa</h5>
                </div>
                <div class="modal-body">
                    Ao rescindir o contrato, será aplicada uma multa proporcional ao prazo restante. Deseja continuar?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <form id="rescindir" action="/rescindir_contrato" method="POST">
                        <button type="submit" class="btn btn-danger">Confirmar Rescisão</button>
                    </form>
                </div>
            </div>
        </div>
    </div> --}}
    {{/if}}

    <!-- Histórico de Contratos -->
    <section class="container my-5">
        <div class="card border-start border-4 shadow-sm p-4 oferta-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4 class="oferta-titulo mb-1">Histórico de Contratos</h4>
                    <small class="oferta-subtitulo">Contratos Ativos e Inativos</small>
                </div>
                <button class="btn oferta-btn-outline-primary" data-bs-toggle="modal"
                    data-bs-target="#modalTodosContratos">
                    <i class="bi bi-file-earmark-text me-2"></i>Ver Todos os Contratos
                </button>
            </div>
        </div>
    </section>

    <!-- Modal para todos os contratos -->
    <div class="modal fade" id="modalTodosContratos" tabindex="-1" aria-labelledby="todosContratosLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div class="modal-header oferta-bg-primary text-white">
                    <h5 class="modal-title" id="todosContratosLabel">
                        <i class="bi bi-list-ul me-2"></i>Todos os Contratos (Ativos e Inativos)
                    </h5>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data de Início</th>
                                <th>Estado</th>
                                <th>Último Valor da Fatura (R$)</th>
                                <th>Valor Economizado (R$)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each contratosCliente}}
                            <tr>
                                <td>{{formatarData this.data_inicio}}</td>
                                <td>{{this.estado_cliente}}</td>
                                <td>{{formatarBR this.valor_fatura_3}}</td>
                                <td>{{formatarBR this.valor_economizado}}</td>
                                <td>
                                    {{#if (eq this.status "A")}}
                                    <span class="badge bg-success">Ativo</span>
                                    {{else}}
                                    <span class="badge bg-secondary">Inativo</span>
                                    {{/if}}
                                </td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalTodosContratos" tabindex="-1" aria-labelledby="todosContratosLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div class="modal-header oferta-bg-primary text-white">
                    <h5 class="modal-title" id="todosContratosLabel">
                        <i class="bi bi-list-ul me-2"></i>Todos os Contratos (Ativos e Inativos)
                    </h5>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data da Assinatura</th>
                                <th>Estado</th>
                                <th>Último Valor da Fatura (R$)</th>
                                <th>Valor Economizado (R$)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each contratosCliente}}
                            <tr>
                                <td>{{formatarData this.data_assinatura}}</td>
                                <td>{{this.estado_cliente}}</td>
                                <td>{{this.valor_fatura_3}}</td>
                                <td>{{this.valor_economizado}}</td>
                                <td>
                                    {{#if (eq this.status "AT")}}
                                    <span class="badge bg-success">Ativo</span>
                                    {{else}}
                                    <span class="badge bg-secondary">Inativo</span>
                                    {{/if}}
                                </td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Dicas -->
    <section class="py-5 bg-white">
        <div class="container">
            <h3 class="mb-4">Dicas para economizar energia e reduzir sua conta</h3>
            <ul>
                <li>Monitore seu consumo regularmente para identificar desperdícios</li>
                <li>Opte por horários de menor tarifa para usar aparelhos de maior consumo</li>
                <li>Invista em aparelhos eficientes e que economizam energia</li>
                <li>Mantenha seu sistema elétrico revisado para evitar perdas e falhas</li>
            </ul>
        </div>

    </section>

    <!-- Espaço -->
    <div style="height: 100px;"></div>

    <!-- Footer -->
    {{> footer }}

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>



    <script>
        window.addEventListener('DOMContentLoaded', () => {
            fetch('/api/estados')
                .then(response => response.json())
                .then(estados => {
                    const selects = document.querySelectorAll('select.uf-select');
                    selects.forEach(select => {
                        estados.forEach(estado => {
                            const option = document.createElement('option');
                            option.value = estado.sigla;
                            option.textContent = `${estado.nome} (${estado.sigla})`;
                            select.appendChild(option);
                        });
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar estados:', error);
                });
        });

    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tooltipTrigger = document.getElementById('tooltipIcon');
            new bootstrap.Tooltip(tooltipTrigger, {
                title: `<img src="/img/elektrokwh.png" alt="Placa Solar" />`,
                html: true,
                placement: 'right',
                sanitize: false
            });

            const tooltipTrigger2 = document.getElementById('tooltipIcon2');
            new bootstrap.Tooltip(tooltipTrigger2, {
                title: `<img src="/img/elektrovalor.png" alt="Nova Imagem" />`,
                html: true,
                placement: 'right',
                sanitize: false
            });
        });
    </script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('estoque') === 'indisponivel') {
            Swal.fire({
                icon: 'error',
                title: 'Estoque insuficiente',
                text: 'Não há energia disponível para esse estado.'
            });
        }
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const botoesPagar = document.querySelectorAll(".btn-pagar");

            botoesPagar.forEach((btn) => {
                btn.addEventListener("click", () => {
                    const idFatura = btn.getAttribute("data-id");
                    const valor = btn.getAttribute("data-valor");

                    document.getElementById("inputIdFatura").value = idFatura;
                    document.getElementById("inputValorFatura").value = valor;

                    document.getElementById("valorFatura").textContent = ` R$ ${valor}`;
                });
            });

            const metodoSelect = document.getElementById("metodoPagamento");

            metodoSelect.addEventListener("change", () => {
                document.getElementById("infoPix").classList.add("d-none");
                document.getElementById("infoCartao").classList.add("d-none");
                document.getElementById("infoBoleto").classList.add("d-none");

                const metodo = metodoSelect.value;
                if (metodo === "pix") document.getElementById("infoPix").classList.remove("d-none");
                else if (metodo === "cartao") document.getElementById("infoCartao").classList.remove("d-none");
                else if (metodo === "boleto") document.getElementById("infoBoleto").classList.remove("d-none");
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.getElementById('btn-rescindir').addEventListener('click', function () {
            Swal.fire({
                title: 'Tem certeza?',
                text: 'Encerrar seu contrato com o Solaro significa abrir mão da sua energia limpa e sustentável. Tem certeza que deseja continuar?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sim, rescindir!',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/rescindir_contrato_cliente', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({}),
                        credentials: 'same-origin'
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire('Sucesso!', data.message, 'success').then(() => location.reload());
                            } else {
                                Swal.fire('Atenção!', data.message, 'warning');
                            }
                        })
                        .catch(err => {
                            console.error('Erro no fetch /rescindir_contrato:', err);
                            Swal.fire('Erro!', 'Erro ao rescindir contrato.', 'error');
                        });

                }
            });
        });
    </script>




</body>

</html>